<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Hockey Event Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Styles (Standard CSS - unchanged) --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
            padding: 1rem;
        }

        @media (min-width: 640px) {
            body {
                padding: 2rem;
            }
        }

        .event-button {
            color: #ffffff;
            font-weight: 700;
            border-radius: 0.375rem;
            border-width: 1px;
            border-style: solid;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
            transform-origin: center;
            font-size: 0.75rem;
            line-height: 1rem;
            cursor: pointer;
        }

        @media (min-width: 640px) {
            .event-button {
                font-size: 0.875rem;
                line-height: 1.25rem;
            }
        }

        .event-button:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .event-button:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            filter: brightness(0.95);
        }

        .event-button:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
        }

        .event-button[data-event] {
            padding: 0.5rem 1rem;
        }

        .btn-blue {
            background-image: linear-gradient(to bottom, #3b82f6, #2563eb);
            border-color: #1d4ed8;
        }

        .btn-blue:hover {
            background-image: linear-gradient(to bottom, #2563eb, #1d4ed8);
        }

        .btn-blue:focus {
            box-shadow: 0 0 0 2px #ffffff, 0 0 0 4px #3b82f6, 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .btn-red {
            background-image: linear-gradient(to bottom, #ef4444, #dc2626);
            border-color: #b91c1c;
        }

        .btn-red:hover {
            background-image: linear-gradient(to bottom, #dc2626, #b91c1c);
        }

        .btn-red:focus {
            box-shadow: 0 0 0 2px #ffffff, 0 0 0 4px #ef4444, 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .btn-green {
            background-image: linear-gradient(to bottom, #22c55e, #16a34a);
            border-color: #15803d;
        }

        .btn-green:hover {
            background-image: linear-gradient(to bottom, #16a34a, #15803d);
        }

        .btn-green:focus {
            box-shadow: 0 0 0 2px #ffffff, 0 0 0 4px #22c55e, 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .btn-yellow {
            background-image: linear-gradient(to bottom, #facc15, #eab308);
            border-color: #ca8a04;
            color: #000000;
        }

        .btn-yellow:hover {
            background-image: linear-gradient(to bottom, #eab308, #ca8a04);
        }

        .btn-yellow:focus {
            box-shadow: 0 0 0 2px #ffffff, 0 0 0 4px #eab308, 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .btn-gray {
            background-image: linear-gradient(to bottom, #6b7280, #4b5563);
            border-color: #374151;
        }

        .btn-gray:hover {
            background-image: linear-gradient(to bottom, #4b5563, #374151);
        }

        .btn-gray:focus {
            box-shadow: 0 0 0 2px #ffffff, 0 0 0 4px #6b7280, 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .event-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-image: none;
            background-color: #9ca3af;
            border-color: #6b7280;
            transform: scale(1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            filter: brightness(1);
        }

        .event-button:disabled:hover {
            background-image: none;
        }

        .event-log-item {
            border-bottom-width: 1px;
            border-color: #e5e7eb;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }

        .button-grid {
            display: grid;
            gap: 0.25rem;
        }

        .group-container {
            border-width: 1px;
            border-color: #d1d5db;
            padding: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            margin-bottom: 1rem;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            font-weight: 500;
            text-align: center;
            border-bottom-width: 2px;
            transition-property: color, border-color;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
            border-color: transparent;
            color: #6b7280;
            cursor: pointer;
        }

        .tab-button:hover {
            color: #374151;
            border-color: #d1d5db;
        }

        .tab-button-active {
            border-color: #3b82f6;
            color: #2563eb;
        }

        .tab-button-active:hover {
            border-color: #3b82f6;
            color: #2563eb;
        }

        .tab-content {
            margin-top: 1rem;
            overflow-y: auto;
            background-color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border-width: 1px;
            border-color: #e5e7eb;
        }

        .xml-output-container {
            height: 22rem;
            overflow-y: auto;
            margin-bottom: 1rem;
            background-color: #ffffff;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #d1d5db;
        }

        .xml-output {
            white-space: pre;
            font-family: monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            color: #333;
        }

        .xml-tag {
            color: #007bff;
        }

        .xml-element {
            color: #dc3545;
        }

        .xml-text {
            color: #28a745;
        }

        #config-view textarea {
            width: 100%;
            min-height: 400px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .config-message {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .config-success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .config-error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        #video-drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            background-color: #f9fafb;
            margin-bottom: 1rem;
            color: #6b7280;
        }

        #video-drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        #videoPlayer {
            width: 100%;
            max-height: 60vh;
            background-color: #000;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        /* --- New Styles for Saved Games --- */
        .saved-game-card {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f9fafb;
            border-radius: 0.375rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s;
        }

        .saved-game-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .saved-game-icon {
            flex-shrink: 0;
            width: 2.5rem;
            height: 2.5rem;
            background-color: #3b82f6;
            color: #ffffff;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }

        .saved-game-details {
            flex-grow: 1;
        }

        .saved-game-details h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
        }

        .saved-game-details p {
            margin: 0;
            font-size: 0.875rem;
            color: #6b7280;
        }

        /* Add scrollable behavior to the List View when height exceeds 22rem */
        #listView {
            max-height: 22rem;
            overflow-y: auto;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="site-icon.png">
    <link rel="apple-touch-icon" sizes="512x512" href="site-icon-large.png">
</head>

<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-xl">

        <nav class="border-b border-gray-700 flex justify-between items-center bg-blue-950 text-white p-4">
            <div class="flex space-x-4">
                <button id="navTracker" class="text-gray-200 hover:text-blue-300">Tracker</button>
                <button id="navStats" class="text-gray-400 hover:text-blue-300 font-medium hidden"
                    data-requires-game>Statistics</button>
                <button id="navLog" class="text-gray-400 hover:text-blue-300 font-medium hidden"
                    data-requires-game>Log</button>
            </div>
            <div class="flex space-x-4 items-center">
                <button id="navSavedGames" class="text-gray-400 hover:text-blue-300 font-medium">Saved Games</button>
                <button id="navConfig" class="text-gray-400 hover:text-blue-300 font-medium">Configure</button>
                <a href="https://github.com/dneimke/simple-coding" target="_blank" rel="noopener"
                    title="Visit the GitHub repository" class="text-gray-200 hover:text-blue-300">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6">
                        <path
                            d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.438 9.8 8.207 11.387.6.113.793-.263.793-.587 0-.287-.012-1.243-.018-2.253-3.338.725-4.042-1.613-4.042-1.613-.546-1.387-1.333-1.756-1.333-1.756-1.09-.744.083-.729.083-.729 1.204.087 1.837 1.237 1.837 1.237 1.07 1.833 2.807 1.303 3.492.996.108-.775.42-1.303.763-1.603-2.665-.303-5.467-1.333-5.467-5.933 0-1.31.468-2.382 1.237-3.222-.123-.303-.537-1.523.117-3.176 0 0 1.01-.324 3.3 1.23a11.5 11.5 0 013.003-.403c1.02.005 2.047.137 3.003.403 2.29-1.554 3.3-1.23 3.3-1.23.654 1.653.24 2.873.117 3.176.768.84 1.236 1.912 1.236 3.222 0 4.61-2.807 5.625-5.478 5.922.432.372.816 1.102.816 2.222 0 1.606-.015 2.898-.015 3.293 0 .324.192.705.798.586C20.565 21.797 24 17.297 24 12c0-6.63-5.37-12-12-12z" />
                    </svg>
                </a>
            </div>
        </nav>

        <div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-xl">
            <div id="tracker-view">
                <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-center text-gray-800">Field Hockey Event Tracker
                </h1>
                <div
                    class="flex flex-col sm:flex-row justify-center items-center mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                    <div id="timer"
                        class="text-4xl font-mono font-bold bg-gray-800 text-white px-6 py-2 rounded-lg shadow">
                        00:00</div>
                    <button id="newGameButton" class="event-button btn-green px-6 py-3 text-lg">Start Game</button>
                    <button id="pauseResumeButton"
                        class="event-button btn-yellow px-6 py-3 text-lg hidden">Pause</button>
                    <button id="completeGameButton"
                        class="event-button btn-blue px-6 py-3 text-lg hidden">Complete</button>
                </div>

                <div id="all-button-groups-container" class="max-w-4xl mx-auto">
                </div>

            </div>

            <div id="config-view" class="hidden">
                <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800">Configure Event Buttons</h1>
                <p class="mb-4 text-gray-600">
                    Edit the JSON below to define the button layout. Buttons defined in 'leftColumn' and 'rightColumn'
                    will
                    appear sequentially in a single column on the Tracker page. Each group has an optional 'gridCols'
                    (e.g.,
                    "grid-cols-4") and an array of 'buttons'. Each button needs an 'event' (unique identifier), 'text'
                    (display label), and 'color' ('btn-blue', 'btn-red', 'btn-green', 'btn-yellow', 'btn-gray').
                </p>
                <div class="mb-4">
                    <label for="configJsonInput" class="block text-gray-700 font-medium mb-2">Configuration JSON</label>
                    <textarea id="configJsonInput" placeholder="Enter your configuration JSON here"></textarea>
                </div>
                <div id="configMessage" class="config-message hidden"></div>
                <div class="flex space-x-4">
                    <button id="saveConfigButton" class="event-button btn-green px-6 py-2">Save Configuration</button>
                    <button id="loadDefaultConfigButton" class="event-button btn-gray px-6 py-2">Load Default</button>
                </div>
                <p class="mt-4 text-sm text-gray-500">Configuration is saved in your browser's local storage. Changes
                    will
                    be applied after saving.</p>
            </div>
            <div id="log-view" class="hidden">
                <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800">Event Log</h1>
                <div class="group-container">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                            <button id="tabButtonList" class="tab-button tab-button-active" data-tab="listView">List
                                View</button>
                            <button id="tabButtonXml" class="tab-button" data-tab="xmlView">XML View</button>
                        </nav>
                    </div>
                    <div>
                        <div id="listView" class="tab-content">
                            <p class="text-gray-500 text-center">No events recorded yet.</p>
                        </div>
                        <div id="xmlView" class="tab-content hidden">
                            <div class="xml-output-container">
                                <div class="xml-output">
                                    <p class="text-gray-500 text-center">No events recorded yet.</p>
                                </div>
                            </div>
                            <button id="copyXmlButton" class="event-button btn-blue w-full py-2">Copy XML</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Statistics View -->
            <div id="stats-view" class="hidden">
                <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800">Game Statistics</h1>
                <div id="statsContainer" class="overflow-x-auto">
                    <!-- Statistics table will be injected here -->
                </div>
            </div>

            <!-- Move the Saved Games view to its own dedicated view -->
            <div id="saved-games-view" class="hidden">
                <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800">Saved Games</h1>
                <div id="savedGamesList" class="mb-4"></div>
            </div>
        </div>


    </div>
    <script>
        // --- Constants & Config --- (Updated)
        const LOCAL_STORAGE_KEY_GAMES = 'fieldHockeyGames_v1';
        const LOCAL_STORAGE_KEY_CONFIG = 'fieldHockeyConfig_v1';
        const CSS_CLASS_EVENT_BUTTON = 'event-button';
        const CSS_CLASS_BTN_BLUE = 'btn-blue';
        const CSS_CLASS_BTN_RED = 'btn-red';
        const CSS_CLASS_BTN_GREEN = 'btn-green';
        const CSS_CLASS_BTN_YELLOW = 'btn-yellow';
        const CSS_CLASS_BTN_GRAY = 'btn-gray';
        const DEFAULT_CONFIG = { /* ... (as before) ... */
            leftColumn: [{ gridCols: "grid-cols-2", buttons: [{ event: "OUTLET", text: "OUTLET", color: "btn-blue" }, { event: "PRESS", text: "PRESS", color: "btn-blue" }] }, { gridCols: "grid-cols-4", buttons: [{ event: "DEF 25 ENTRY", text: "DEF 25 ENTRY", color: "btn-red" }, { event: "DEF CIRC ENTRY", text: "DEF CIRC ENTRY", color: "btn-red" }, { event: "SHOT AG", text: "SHOT AG", color: "btn-red" }, { event: "GOAL AG", text: "GOAL AG", color: "btn-red" }] }, { gridCols: "grid-cols-4", buttons: [{ event: "ATT 25 ENTRY", text: "ATT 25 ENTRY", color: "btn-green" }, { event: "ATT CIRC ENTRY", text: "ATT CIRC ENTRY", color: "btn-green" }, { event: "SHOT FOR", text: "SHOT FOR", color: "btn-green" }, { event: "GOAL FOR", text: "GOAL FOR", color: "btn-green" }] }, { gridCols: "grid-cols-4", buttons: [{ event: "APC", text: "APC", color: "btn-blue" }, { event: "DPC", text: "DPC", color: "btn-blue" }, { event: "STROKE", text: "STROKE", color: "btn-blue" }, { event: "1V1", text: "1V1", color: "btn-blue" }] }, { gridCols: "grid-cols-5", buttons: [{ event: "3 PASS", text: "3 PASS", color: "btn-yellow" }, { event: "TACKLE", text: "TACKLE", color: "btn-yellow" }, { event: "DEF", text: "DEF", color: "btn-yellow" }, { event: "MF", text: "MF", color: "btn-yellow" }, { event: "ATT", text: "ATT", color: "btn-yellow" }] }, { gridCols: "grid-cols-4", buttons: [{ event: "OVERHEAD FOR", text: "OVERHEAD FOR", color: "btn-blue" }, { event: "OVERHEAD AG", text: "OVERHEAD AG", color: "btn-blue" }, { event: "CIRC-DEF", text: "CIRC-DEF", color: "btn-blue" }, { event: "CLOSE-BASE", text: "CLOSE-BASE", color: "btn-blue" }] }, { gridCols: "grid-cols-4", buttons: [{ event: "P1", text: "P1", color: "btn-blue" }, { event: "P2", text: "P2", color: "btn-blue" }, { event: "P3", text: "P3", color: "btn-blue" }, { event: "P4", text: "P4", color: "btn-blue" }] }, { gridCols: "grid-cols-3", buttons: [{ event: "CARD", text: "CARD", color: "btn-green" }, { event: "INJURY", text: "INJURY", color: "btn-green" }, { event: "WHISTLE", text: "WHISTLE", color: "btn-green" }] }],
            rightColumn: []
        };

        // Update references to use constants
        const timerDisplay = document.getElementById('timer');
        const newGameButton = document.getElementById('newGameButton');
        const pauseResumeButton = document.getElementById('pauseResumeButton');
        const completeGameButton = document.getElementById('completeGameButton');
        const tabButtonList = document.getElementById('tabButtonList');
        const tabButtonXml = document.getElementById('tabButtonXml');
        const listViewPanel = document.getElementById('listView');
        const xmlViewPanel = document.getElementById('xmlView');
        const xmlOutputContainer = xmlViewPanel.querySelector('.xml-output');
        const copyXmlButton = document.getElementById('copyXmlButton');
        const allButtonGroupsContainer = document.getElementById('all-button-groups-container');

        // Navigation Elements
        const navTracker = document.getElementById('navTracker');
        const navConfig = document.getElementById('navConfig');
        const navLog = document.getElementById('navLog');
        const navStats = document.getElementById('navStats');
        const navSavedGames = document.getElementById('navSavedGames');

        // View Elements
        const trackerView = document.getElementById('tracker-view');
        const configView = document.getElementById('config-view');
        const logView = document.getElementById('log-view');
        const statsView = document.getElementById('stats-view');
        const savedGamesView = document.getElementById('saved-games-view');

        const configJsonInput = document.getElementById('configJsonInput');
        const saveConfigButton = document.getElementById('saveConfigButton');
        const loadDefaultConfigButton = document.getElementById('loadDefaultConfigButton');
        const configMessage = document.getElementById('configMessage');
        const videoDropZone = document.getElementById('video-drop-zone');
        const videoFileInput = document.getElementById('videoFile');
        const videoFileName = document.getElementById('videoFileName');
        const videoPlayer = document.getElementById('videoPlayer');

        // --- State Management
        const currentGameState = {
            loggedEvents: [],
            isRunning: false,
            elapsedTime: 0,
            startTime: 0,
            timerInterval: null,
            hasCurrentGame: false,
            isActive: false,
            setGameState({ loggedEvents = [], elapsedTime = 0, hasCurrentGame = false, isActive = false }) {
                this.loggedEvents = loggedEvents;
                this.elapsedTime = elapsedTime;
                this.hasCurrentGame = hasCurrentGame;
                this.isActive = isActive;
                renderEventLog();
            },
        };

        // Update references to use currentGameState
        let eventButtons = [];
        let currentVideoURL = null;
        let videoDuration = 0;
        let gameStatistics = {}; // To store statistics for the current game

        // --- Functions --- (Updated)

        function initializeNewGame(game) {

            currentGameState.setGameState(game);
            timerDisplay.textContent = '00:00';
            newGameButton.style.display = 'inline-block';
            pauseResumeButton.style.display = 'none';
            completeGameButton.style.display = 'none';

            if (game.isActive === true) {
                startTimer();

                newGameButton.style.display = 'none';
                pauseResumeButton.style.display = 'inline-block';
                completeGameButton.style.display = 'inline-block';
            }

            updateNavbarVisibility();
        }

        function updateTimer() {
            const currentTime = Date.now();
            const currentElapsedTime = currentGameState.isRunning ? currentGameState.elapsedTime + (currentTime - currentGameState.startTime) : currentGameState.elapsedTime;
            timerDisplay.textContent = formatTime(currentElapsedTime);
        }

        function startTimer() {
            if (currentGameState.isRunning) return;

            currentGameState.startTime = Date.now();
            currentGameState.timerInterval = setInterval(updateTimer, 100);
            currentGameState.isRunning = true;

            pauseResumeButton.textContent = 'Pause';
            pauseResumeButton.classList.remove('btn-green');
            pauseResumeButton.classList.add('btn-yellow');
            pauseResumeButton.style.color = '#000000';

            enableEventButtons(true);
        }

        function pauseTimer() {
            if (!currentGameState.isRunning) return;

            clearInterval(currentGameState.timerInterval);

            const currentTime = Date.now();
            currentGameState.elapsedTime += (currentTime - currentGameState.startTime);
            currentGameState.isRunning = false;

            pauseResumeButton.textContent = 'Resume';
            pauseResumeButton.classList.remove('btn-yellow');
            pauseResumeButton.classList.add('btn-green');
            pauseResumeButton.style.color = '#ffffff';

            enableEventButtons(false);
        }

        function resetTimerAndLog() {
            pauseTimer();
            currentGameState.setGameState({
                loggedEvents: [],
                elapsedTime: 0,
                hasCurrentGame: false,
            });

            timerDisplay.textContent = '00:00';
            newGameButton.style.display = 'inline-block';
            pauseResumeButton.style.display = 'none';
            completeGameButton.style.display = 'none';

            renderEventLog();
            enableEventButtons(false);
        }

        function enableEventButtons(enable) {
            const logIsEmpty = currentGameState.loggedEvents.length === 0;
            eventButtons.forEach(button => {
                button.disabled = !enable;
            });
            copyXmlButton.disabled = logIsEmpty;
        }

        function handleEventButtonClick(e) {
            if (!currentGameState.isActive) {
                console.warn("Timer not started. Event not logged.");
                timerDisplay.classList.add('animate-pulse');
                setTimeout(() => timerDisplay.classList.remove('animate-pulse'), 1000);
                return;
            }
            const eventName = e.target.dataset.event;
            const currentElapsedTimeMs = currentGameState.isRunning ? currentGameState.elapsedTime + (Date.now() - currentGameState.startTime) : currentGameState.elapsedTime;
            currentGameState.loggedEvents.push({ event: eventName, timeMs: currentElapsedTimeMs });
            renderEventLog();
        }

        function switchTab(tabToShow) {
            const isListView = tabToShow === 'listView';
            tabButtonList.classList.toggle('tab-button-active', isListView);
            tabButtonXml.classList.toggle('tab-button-active', !isListView);
            tabButtonList.classList.toggle('tab-button', !isListView);
            tabButtonXml.classList.toggle('tab-button', isListView);
            listViewPanel.classList.toggle('hidden', !isListView);
            xmlViewPanel.classList.toggle('hidden', isListView);
        }

        function showView(viewToShow) {
            trackerView.classList.add('hidden');
            configView.classList.add('hidden');
            logView.classList.add('hidden');
            statsView.classList.add('hidden');
            savedGamesView.classList.add('hidden');

            const navButtons = [navTracker, navStats, navLog, navSavedGames, navConfig];
            navButtons.forEach(button => {
                button.classList.remove('text-white', 'hover:text-white');
                button.classList.add('text-gray-400', 'hover:text-blue-300');
            });

            updateNavbarVisibility();

            let activeView;
            let activeButton;
            if (viewToShow === 'tracker') {
                activeView = trackerView;
                activeButton = navTracker;
            } else if (viewToShow === 'config') {
                activeView = configView;
                activeButton = navConfig;
                const currentConfig = loadConfig();
                configJsonInput.value = JSON.stringify(currentConfig, null, 2);
            } else if (viewToShow === 'log') {
                activeView = logView;
                activeButton = navLog;
                renderEventLog();
            } else if (viewToShow === 'statistics') {
                activeView = statsView;
                activeButton = navStats;
                renderStatistics();
            } else if (viewToShow === 'saved-games') {
                activeView = savedGamesView;
                activeButton = navSavedGames;
            }

            // text-white hover:text-blue-400
            if (activeView && activeButton) {
                activeView.classList.remove('hidden');
                activeButton.classList.add('text-white', 'hover:text-white');
                activeButton.classList.remove('text-gray-400', 'hover:text-blue-300');
            }
        }

        function loadConfig() { try { const savedConfig = localStorage.getItem(LOCAL_STORAGE_KEY_CONFIG); if (savedConfig) { const parsed = JSON.parse(savedConfig); if (parsed && Array.isArray(parsed.leftColumn) && Array.isArray(parsed.rightColumn)) { console.log("Loaded config from localStorage"); return parsed; } else { console.warn("Invalid config structure in localStorage, using default."); return DEFAULT_CONFIG; } } } catch (error) { console.error("Error loading or parsing config from localStorage:", error); } console.log("No valid config in localStorage, using default."); return DEFAULT_CONFIG; }
        function saveConfig(configObject) { try { localStorage.setItem(LOCAL_STORAGE_KEY_CONFIG, JSON.stringify(configObject)); console.log("Configuration saved to localStorage."); return true; } catch (error) { console.error("Error saving config to localStorage:", error); if (error.name === 'QuotaExceededError') { alert('Error: Could not save configuration. Browser storage limit exceeded.'); } return false; } }
        function showConfigMessage(message, isError = false) { configMessage.textContent = message; configMessage.className = 'config-message'; if (isError) { configMessage.classList.add('config-error'); } else { configMessage.classList.add('config-success'); } configMessage.classList.remove('hidden'); setTimeout(() => { configMessage.classList.add('hidden'); }, 5000); }
        function escapeXml(unsafe) { if (typeof unsafe !== 'string') return unsafe; return unsafe.replace(/[<>&'"]/g, function (c) { switch (c) { case '<': return '&lt;'; case '>': return '&gt;'; case '&': return '&amp;'; case '\'': return '&apos;'; case '"': return '&quot;'; default: return c; } }); }
        function generatePlainXml(events) { let xmlString = ''; events.forEach((logEntry, index) => { const eventTimeSeconds = Math.floor(logEntry.timeMs / 1000); const startSeconds = Math.max(0, eventTimeSeconds - 5); const endSeconds = eventTimeSeconds + 5; const eventCode = escapeXml(logEntry.event); xmlString += `<instance><ID>${index + 1}</ID><start>${startSeconds}</start><end>${endSeconds}</end><code>${eventCode}</code></instance>\n`; }); return xmlString.trim(); }

        /** Renders button groups and buttons based on config into a single column */
        function renderButtons(config) {

            const targetContainer = allButtonGroupsContainer;
            targetContainer.innerHTML = '';

            const renderGroup = (group) => {
                if (!group || !Array.isArray(group.buttons)) {
                    console.warn("Skipping invalid group in config:", group);
                    return; // Skip invalid groups
                }
                const groupContainer = document.createElement('div');
                groupContainer.className = 'group-container';

                const buttonGrid = document.createElement('div');
                const gridColsClass = group.gridCols || 'grid-cols-4'; // Default if not specified
                buttonGrid.className = `button-grid ${gridColsClass}`;

                group.buttons.forEach(buttonConfig => {
                    if (!buttonConfig || !buttonConfig.event || !buttonConfig.text || !buttonConfig.color) {
                        console.warn("Skipping invalid button config:", buttonConfig);
                        return; // Skip invalid buttons
                    }
                    const button = document.createElement('button');
                    button.className = `event-button ${buttonConfig.color}`;
                    button.style.padding = '0.5rem 1rem'; // Explicit padding
                    button.textContent = buttonConfig.text;
                    button.dataset.event = buttonConfig.event;
                    if (buttonConfig.span) {
                        button.classList.add(buttonConfig.span);
                    }
                    buttonGrid.appendChild(button);
                });

                groupContainer.appendChild(buttonGrid);
                allButtonGroupsContainer.appendChild(groupContainer);
            };

            // Render groups from leftColumn first, then rightColumn
            if (config.leftColumn && Array.isArray(config.leftColumn)) {
                config.leftColumn.forEach(renderGroup);
            }
            if (config.rightColumn && Array.isArray(config.rightColumn)) {
                config.rightColumn.forEach(renderGroup);
            }

            // Re-query buttons and attach listeners
            eventButtons = document.querySelectorAll('.event-button[data-event]');
            eventButtons.forEach(button => {
                button.removeEventListener('click', handleEventButtonClick);
                button.addEventListener('click', handleEventButtonClick);
            });

            // Ensure buttons are enabled/disabled correctly
            enableEventButtons(currentGameState.isActive);
        }

        // --- Reusable Components ---


        function createButton({ text, className, onClick }) {
            const button = document.createElement('button');
            button.className = className;
            button.textContent = text;
            if (onClick) {
                button.addEventListener('click', onClick);
            }
            return button;
        }

        function createGameCard({ game, index, onLoad, onDelete }) {
            const gameCard = document.createElement('div');
            gameCard.className = 'saved-game-card flex items-center p-4 mb-4 bg-gray-100 rounded-lg shadow-md hover:shadow-lg transition-shadow';

            const icon = document.createElement('div');
            icon.className = 'saved-game-icon flex-shrink-0 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center mr-4';
            icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c.828 0 1.5-.672 1.5-1.5S12.828 5 12 5s-1.5.672-1.5 1.5S11.172 8 12 8zm0 0v8m0 0H9m3 0h3" /></svg>';

            const gameDetails = document.createElement('div');
            gameDetails.className = 'saved-game-details flex-grow';

            const gameTitle = document.createElement('h3');
            gameTitle.className = 'text-lg font-bold text-gray-800';
            gameTitle.textContent = `Game ${index + 1}`;

            const gameTimestamp = document.createElement('p');
            gameTimestamp.className = 'text-sm text-gray-600';
            gameTimestamp.textContent = `Saved on: ${new Date(game.timestamp).toLocaleString()}`;

            const eventCount = document.createElement('p');
            eventCount.className = 'text-sm text-gray-600';
            eventCount.textContent = `Events: ${game.events.length}`;

            gameDetails.appendChild(gameTitle);
            gameDetails.appendChild(gameTimestamp);
            gameDetails.appendChild(eventCount);

            const loadButton = createButton({
                text: 'Load',
                className: 'event-button btn-blue px-4 py-2 text-sm',
                onClick: onLoad
            });

            const deleteButton = createButton({
                text: 'Delete',
                className: 'event-button btn-red px-4 py-2 text-sm ml-2',
                onClick: onDelete
            });

            gameCard.appendChild(icon);
            gameCard.appendChild(gameDetails);
            gameCard.appendChild(loadButton);
            gameCard.appendChild(deleteButton);

            return gameCard;
        }

        function createLogEntry({ event, time }) {
            const logItem = document.createElement('div');
            logItem.className = 'event-log-item';
            logItem.innerHTML = `<span class="font-medium text-gray-700">${escapeXml(event)}</span> <span class="text-gray-500">${formatTime(time)}</span>`;
            return logItem;
        }

        // --- Refactored Functions ---


        function renderSavedGamesList() {
            const savedGamesList = document.getElementById('savedGamesList');
            savedGamesList.innerHTML = '';

            try {
                const savedGames = JSON.parse(localStorage.getItem('fieldHockeyGames_v1')) || [];
                if (savedGames.length > 0) {
                    savedGames.forEach((game, index) => {
                        const gameCard = createGameCard({
                            game,
                            index,
                            onLoad: () => {
                                if (currentGameState.isRunning) {
                                    if (confirm('A game is currently in progress. Do you want to stop it and load the saved game?')) {
                                        pauseTimer();
                                    } else {
                                        return;
                                    }
                                }

                                initializeNewGame({
                                    loggedEvents: [...game.events],
                                    elapsedTime: 0,
                                    hasCurrentGame: true,
                                    isActive: false,
                                });

                                console.log(`Game ${index + 1} loaded successfully.`);
                                showView('statistics');
                            },
                            onDelete: () => {
                                if (confirm('Are you sure you want to delete this saved game?')) {
                                    savedGames.splice(index, 1);
                                    localStorage.setItem('fieldHockeyGames_v1', JSON.stringify(savedGames));
                                    renderSavedGamesList();
                                }
                            }
                        });

                        savedGamesList.appendChild(gameCard);
                    });
                } else {
                    savedGamesList.innerHTML = '<p class="text-gray-500 text-center">No saved games available.</p>';
                }
            } catch (error) {
                console.error('Error loading games from localStorage:', error);
                savedGamesList.innerHTML = '<p class="text-red-500 text-center">Failed to load saved games.</p>';
            }
        }

        function renderEventLog() {
            const loggedEvents = currentGameState.loggedEvents;
            const logIsEmpty = loggedEvents.length === 0;

            if (logIsEmpty) {
                listViewPanel.innerHTML = '<p class="text-gray-500 text-center">No events recorded yet.</p>';
                xmlOutputContainer.innerHTML = '<p class="text-gray-500 text-center">No events recorded yet.</p>';
                return;
            }

            listViewPanel.innerHTML = '';
            xmlOutputContainer.innerHTML = '';

            loggedEvents.slice().reverse().forEach(logEntry => {
                const logItem = createLogEntry({
                    event: logEntry.event,
                    time: logEntry.timeMs
                });
                listViewPanel.appendChild(logItem);
            });

            let styledXmlString = '';
            loggedEvents.forEach((logEntry, index) => {
                const eventTimeSeconds = Math.floor(logEntry.timeMs / 1000);
                const startSeconds = Math.max(0, eventTimeSeconds - 5);
                const endSeconds = eventTimeSeconds + 5;
                const eventCode = escapeXml(logEntry.event);
                styledXmlString += `<span class="xml-tag">&lt;instance&gt;</span><span class="xml-tag">&lt;ID&gt;</span><span class="xml-text">${index + 1}</span><span class="xml-tag">&lt;/ID&gt;</span><span class="xml-tag">&lt;start&gt;</span><span class="xml-text">${startSeconds}</span><span class="xml-tag">&lt;/start&gt;</span><span class="xml-tag">&lt;end&gt;</span><span class="xml-text">${endSeconds}</span><span class="xml-tag">&lt;/end&gt;</span><span class="xml-tag">&lt;code&gt;</span><span class="xml-text">${eventCode}</span><span class="xml-tag">&lt;/code&gt;</span><span class="xml-tag">&lt;/instance&gt;</span>\n`;
            });
            xmlOutputContainer.innerHTML = styledXmlString;

            copyXmlButton.disabled = logIsEmpty;
        }

        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function computeGameStatistics() {
            gameStatistics = currentGameState.loggedEvents.reduce((stats, event) => {
                stats[event.event] = (stats[event.event] || 0) + 1;
                return stats;
            }, {});
        }


        function loadVideo(file) { if (!file || !file.type.startsWith('video/')) { alert('Please select a valid video file.'); return; } if (currentVideoURL) { URL.revokeObjectURL(currentVideoURL); } currentVideoURL = URL.createObjectURL(file); videoPlayer.src = currentVideoURL; videoFileName.textContent = file.name; }


        // --- Initialization --- (Updated)
        function initApp() {
            const currentConfig = loadConfig();
            renderButtons(currentConfig);

            // Attach listeners
            tabButtonList.addEventListener('click', () => switchTab('listView'));
            tabButtonXml.addEventListener('click', () => switchTab('xmlView'));
            copyXmlButton.addEventListener('click', copyXmlToClipboard);
            navTracker.addEventListener('click', () => showView('tracker'));
            navStats.addEventListener('click', () => showView('statistics'));
            navConfig.addEventListener('click', () => showView('config'));
            navLog.addEventListener('click', () => showView('log'));
            navSavedGames.addEventListener('click', () => {
                renderSavedGamesList();
                showView('saved-games');
            });

            newGameButton.addEventListener('click', () => {
                let game = {
                    loggedEvents: [],
                    elapsedTime: 0,
                    hasCurrentGame: true,
                    isActive: true,
                };

                initializeNewGame(game);
            });

            pauseResumeButton.addEventListener('click', () => {
                if (currentGameState.isRunning) {
                    pauseTimer();
                } else {
                    startTimer();
                }
            });

            // Refactored code to use modern JavaScript features
            completeGameButton.addEventListener('click', async () => {
                const userConfirmed = confirm('Are you sure you want to complete the game? This will reset all progress.');
                if (userConfirmed) {
                    await saveGameToLocalStorage();
                    resetTimerAndLog();
                    updateNavbarVisibility();
                }
            });

            saveConfigButton.addEventListener('click', () => { try { const jsonString = configJsonInput.value; const parsedConfig = JSON.parse(jsonString); if (parsedConfig && Array.isArray(parsedConfig.leftColumn) && Array.isArray(parsedConfig.rightColumn)) { if (saveConfig(parsedConfig)) { showConfigMessage("Configuration saved successfully!", false); renderButtons(parsedConfig); } else { showConfigMessage("Failed to save configuration.", true); } } else { showConfigMessage("Invalid configuration structure. Please check the JSON format.", true); } } catch (error) { console.error("Invalid JSON:", error); showConfigMessage(`Error parsing JSON: ${error.message}`, true); } });
            loadDefaultConfigButton.addEventListener('click', () => { configJsonInput.value = JSON.stringify(DEFAULT_CONFIG, null, 2); showConfigMessage("Default configuration loaded into editor. Click 'Save Configuration' to apply.", false); });

            // Initial UI state
            renderEventLog();
            enableEventButtons(false);
            switchTab('listView');
            showView('tracker');

            resetTimerAndLog = (function (originalReset) {
                return function () {
                    originalReset();
                    // updateGameStateIndicator();
                };
            })(resetTimerAndLog);

            // Add visual feedback for event buttons
            function addVisualFeedbackToButtons() {
                eventButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        button.classList.add('clicked');
                        setTimeout(() => button.classList.remove('clicked'), 200);
                    });
                });
            }

            // Call the function after rendering buttons
            renderButtons = (function (originalRenderButtons) {
                return function (config) {
                    originalRenderButtons(config);
                    addVisualFeedbackToButtons();
                };
            })(renderButtons);

        }

        // --- Run Initialization
        initApp();

        // Modify saveGameToLocalStorage to retain up to the last 5 saved games
        function saveGameToLocalStorage() {
            const gameData = {
                events: currentGameState.loggedEvents,
                elapsedTime: currentGameState.elapsedTime,
                timestamp: new Date().toISOString()
            };

            try {
                const savedGames = JSON.parse(localStorage.getItem('fieldHockeyGames_v1')) || [];
                savedGames.push(gameData);

                // Retain only the last 5 games
                while (savedGames.length > 5) {
                    savedGames.shift();
                }

                localStorage.setItem('fieldHockeyGames_v1', JSON.stringify(savedGames));
                console.log('Game saved successfully.');
            } catch (error) {
                console.error('Error saving game to localStorage:', error);
            }
        }

        function updateNavbarVisibility() {
            const requiresGameButtons = document.querySelectorAll('[data-requires-game]');
            requiresGameButtons.forEach(button => {
                button.classList.toggle('hidden', !currentGameState.hasCurrentGame);
            });
        }

        // Update navbar visibility on game state changes
        resetTimerAndLog = (function (originalReset) {
            return function () {
                originalReset();
                updateNavbarVisibility();
            };
        })(resetTimerAndLog);

        // Initial visibility update
        updateNavbarVisibility();

        function copyXmlToClipboard() {
            const xmlContent = xmlOutputContainer.textContent;
            if (!xmlContent) {
                console.warn("No XML content to copy.");
                return;
            }
            navigator.clipboard.writeText(xmlContent).then(() => {
                console.log("XML content copied to clipboard.");
                alert("XML content copied to clipboard.");
            }).catch(err => {
                console.error("Failed to copy XML content to clipboard:", err);
                alert("Failed to copy XML content to clipboard.");
            });
        }

        function renderStatistics() {
            computeGameStatistics();
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = '';

            if (Object.keys(gameStatistics).length === 0) {
                statsContainer.innerHTML = '<p class="text-gray-500 text-center">No statistics available. Record some events to see statistics.</p>';
                return;
            }

            // Sort statistics by event name
            const sortedStatistics = Object.entries(gameStatistics).sort(([eventA], [eventB]) => eventA.localeCompare(eventB));

            const table = document.createElement('table');
            table.className = 'min-w-full bg-white border border-gray-200';

            const thead = document.createElement('thead');
            thead.className = 'bg-gray-100';
            const headerRow = document.createElement('tr');

            const eventHeader = document.createElement('th');
            eventHeader.className = 'px-4 py-2 text-left text-sm font-medium text-gray-600 border-b';
            eventHeader.textContent = 'Event';
            headerRow.appendChild(eventHeader);

            const countHeader = document.createElement('th');
            countHeader.className = 'px-4 py-2 text-left text-sm font-medium text-gray-600 border-b';
            countHeader.textContent = 'Count';
            headerRow.appendChild(countHeader);

            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            Object.entries(gameStatistics).forEach(([event, count]) => {
                const row = document.createElement('tr');

                const eventCell = document.createElement('td');
                eventCell.className = 'px-4 py-2 text-sm text-gray-700 border-b';
                eventCell.textContent = event;
                row.appendChild(eventCell);

                const countCell = document.createElement('td');
                countCell.className = 'px-4 py-2 text-sm text-gray-700 border-b';
                countCell.textContent = count;
                row.appendChild(countCell);

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            statsContainer.appendChild(table);
        }

    </script>

</body>

</html>