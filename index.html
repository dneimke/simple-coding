<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Hockey Event Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="site-icon.png">
    <link rel="apple-touch-icon" sizes="512x512" href="site-icon-large.png">
</head>

<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-xl">

        <nav class="border-b border-slate-700 flex justify-between items-center bg-slate-950 text-white p-4">
            <div class="flex space-x-4">
                <button id="navTracker" class="text-gray-200 hover:text-white-300">Tracker</button>
                <button id="navStats" class="text-gray-400 hover:text-white-300 font-medium hidden"
                    data-requires-game>Statistics</button>
                <button id="navLog" class="text-gray-400 hover:text-white-300 font-medium hidden"
                    data-requires-game>Log</button>
            </div>
            <div class="flex space-x-4 items-center">
                <button id="navSavedGames" class="text-gray-400 hover:text-white-300 font-medium">Saved Games</button>
                <button id="navConfig" class="text-gray-400 hover:text-white-300 font-medium">Configure</button>
                <a href="https://github.com/dneimke/simple-coding" target="_blank" rel="noopener"
                    title="Visit the GitHub repository" class="text-gray-200 hover:text-white-300">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6">
                        <path
                            d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.438 9.8 8.207 11.387.6.113.793-.263.793-.587 0-.287-.012-1.243-.018-2.253-3.338.725-4.042-1.613-4.042-1.613-.546-1.387-1.333-1.756-1.333-1.756-1.09-.744.083-.729.083-.729 1.204.087 1.837 1.237 1.837 1.237 1.07 1.833 2.807 1.303 3.492.996.108-.775.42-1.303.763-1.603-2.665-.303-5.467-1.333-5.467-5.933 0-1.31.468-2.382 1.237-3.222-.123-.303-.537-1.523.117-3.176 0 0 1.01-.324 3.3 1.23a11.5 11.5 0 013.003-.403c1.02.005 2.047.137 3.003.403 2.29-1.554 3.3-1.23 3.3-1.23.654 1.653.24 2.873.117 3.176.768.84 1.236 1.912 1.236 3.222 0 4.61-2.807 5.625-5.478 5.922.432.372.816 1.102.816 2.222 0 1.606-.015 2.898-.015 3.293 0 .324.192.705.798.586C20.565 21.797 24 17.297 24 12c0-6.63-5.37-12-12-12z" />
                    </svg>
                </a>
            </div>
        </nav>

        <div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-xl">

            <!-- Tracker View -->
            <div id="tracker-view">
                <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-center text-gray-800">Field Hockey Event Tracker
                </h1>
                <div
                    class="flex flex-col sm:flex-row justify-center items-center mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                    <div id="timer"
                        class="text-4xl font-mono font-bold bg-gray-800 text-white px-6 py-2 rounded-lg shadow">
                        00:00</div>
                    <button id="newGameButton" class="event-button btn-green px-6 py-3 text-lg">Start Game</button>
                    <button id="pauseResumeButton"
                        class="event-button btn-yellow px-6 py-3 text-lg hidden">Pause</button>
                    <button id="completeGameButton"
                        class="event-button btn-blue px-6 py-3 text-lg hidden">Complete</button>
                </div>

                <div id="coding-buttons-container" class="max-w-4xl mx-auto">
                </div>
            </div>

            <!-- Configuration View -->
            <div id="config-view" class="hidden">
                <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800">Configure Event Buttons</h1>
                <p class="mb-4 text-gray-600">
                    Edit the JSON below to define the button layout. Buttons defined in 'leftColumn' and 'rightColumn'
                    will
                    appear sequentially in a single column on the Tracker page. Each group has an optional 'gridCols'
                    (e.g.,
                    "grid-cols-4") and an array of 'buttons'. Each button needs an 'event' (unique identifier), 'text'
                    (display label), and 'color' ('btn-blue', 'btn-red', 'btn-green', 'btn-yellow', 'btn-gray').
                </p>
                <div class="mb-4">
                    <label for="configJsonInput" class="block text-gray-700 font-medium mb-2">Configuration JSON</label>
                    <textarea id="configJsonInput" placeholder="Enter your configuration JSON here"></textarea>
                </div>
                <div id="configMessage" class="config-message hidden"></div>
                <div class="flex space-x-4">
                    <button id="saveConfigButton" class="event-button btn-green px-6 py-2">Save Configuration</button>
                    <button id="loadDefaultConfigButton" class="event-button btn-gray px-6 py-2">Load Default</button>
                </div>
                <p class="mt-4 text-sm text-gray-500">Configuration is saved in your browser's local storage. Changes
                    will be applied after saving.</p>
            </div>

            <!-- Log View -->
            <div id="log-view" class="hidden">
                <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800">Event Log</h1>
                <div class="group-container">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                            <button id="tabButtonList" class="tab-button tab-button-active" data-tab="listView">List
                                View</button>
                            <button id="tabButtonXml" class="tab-button" data-tab="xmlView">XML View</button>
                        </nav>
                    </div>
                    <div>
                        <div id="listView" class="tab-content">
                            <p class="text-gray-500 text-center">No events recorded yet.</p>
                        </div>
                        <div id="xmlView" class="tab-content hidden">
                            <div class="xml-output-container">
                                <div class="xml-output">
                                    <p class="text-gray-500 text-center">No events recorded yet.</p>
                                </div>
                            </div>
                            <button id="copyXmlButton" class="event-button btn-blue w-full py-2">Copy XML</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Statistics View -->
            <div id="stats-view" class="hidden">
                <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800">Game Statistics</h1>
                <div id="statsContainer" class="overflow-x-auto">
                    <!-- Statistics table will be injected here -->
                </div>
            </div>

            <!-- Saved Games View -->
            <div id="saved-games-view" class="hidden">
                <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800">Saved Games</h1>
                <div id="savedGamesList" class="mb-4"></div>
            </div>
        </div>


    </div>
    <script type="module" src="utils.js"></script>
    <script type="module">
        import {
            createButton, createGameCard,
            computeGameStatistics,
            createLogEntry,
            copyXmlToClipboard, generatePlainXml, escapeXml,
            formatTime,
            updateNavbarVisibility,
            showMessage,
            saveGameToLocalStorage, loadSavedGames, deleteSavedGame,
            loadConfig, saveConfig,
            addVisualFeedbackToButtons
        } from './utils.js';

        // --- Constants & Config --- (Updated)
        const LOCAL_STORAGE_KEY_GAMES = 'fieldHockeyGames_v1';
        const LOCAL_STORAGE_KEY_CONFIG = 'fieldHockeyConfig_v1';
        const CSS_CLASS_EVENT_BUTTON = 'event-button';
        const CSS_CLASS_BTN_BLUE = 'btn-blue';
        const CSS_CLASS_BTN_RED = 'btn-red';
        const CSS_CLASS_BTN_GREEN = 'btn-green';
        const CSS_CLASS_BTN_YELLOW = 'btn-yellow';
        const CSS_CLASS_BTN_GRAY = 'btn-gray';
        const DEFAULT_CONFIG = {
            rowDefs: [{ gridCols: "grid-cols-2", buttons: [{ event: "OUTLET", text: "OUTLET", color: "btn-blue" }, { event: "PRESS", text: "PRESS", color: "btn-blue" }] }, { gridCols: "grid-cols-4", buttons: [{ event: "DEF 25 ENTRY", text: "DEF 25 ENTRY", color: "btn-red" }, { event: "DEF CIRC ENTRY", text: "DEF CIRC ENTRY", color: "btn-red" }, { event: "SHOT AG", text: "SHOT AG", color: "btn-red" }, { event: "GOAL AG", text: "GOAL AG", color: "btn-red" }] }, { gridCols: "grid-cols-4", buttons: [{ event: "ATT 25 ENTRY", text: "ATT 25 ENTRY", color: "btn-green" }, { event: "ATT CIRC ENTRY", text: "ATT CIRC ENTRY", color: "btn-green" }, { event: "SHOT FOR", text: "SHOT FOR", color: "btn-green" }, { event: "GOAL FOR", text: "GOAL FOR", color: "btn-green" }] }, { gridCols: "grid-cols-4", buttons: [{ event: "APC", text: "APC", color: "btn-blue" }, { event: "DPC", text: "DPC", color: "btn-blue" }, { event: "STROKE", text: "STROKE", color: "btn-blue" }, { event: "1V1", text: "1V1", color: "btn-blue" }] }, { gridCols: "grid-cols-5", buttons: [{ event: "3 PASS", text: "3 PASS", color: "btn-yellow" }, { event: "TACKLE", text: "TACKLE", color: "btn-yellow" }, { event: "DEF", text: "DEF", color: "btn-yellow" }, { event: "MF", text: "MF", color: "btn-yellow" }, { event: "ATT", text: "ATT", color: "btn-yellow" }] }, { gridCols: "grid-cols-4", buttons: [{ event: "OVERHEAD FOR", text: "OVERHEAD FOR", color: "btn-blue" }, { event: "OVERHEAD AG", text: "OVERHEAD AG", color: "btn-blue" }, { event: "CIRC-DEF", text: "CIRC-DEF", color: "btn-blue" }, { event: "CLOSE-BASE", text: "CLOSE-BASE", color: "btn-blue" }] }, { gridCols: "grid-cols-4", buttons: [{ event: "P1", text: "P1", color: "btn-blue" }, { event: "P2", text: "P2", color: "btn-blue" }, { event: "P3", text: "P3", color: "btn-blue" }, { event: "P4", text: "P4", color: "btn-blue" }] }, { gridCols: "grid-cols-3", buttons: [{ event: "CARD", text: "CARD", color: "btn-green" }, { event: "INJURY", text: "INJURY", color: "btn-green" }, { event: "WHISTLE", text: "WHISTLE", color: "btn-green" }] }]
        };

        // Update references to use constants
        const timerDisplay = document.getElementById('timer');
        const tabButtonList = document.getElementById('tabButtonList');
        const tabButtonXml = document.getElementById('tabButtonXml');
        const listViewPanel = document.getElementById('listView');
        const xmlViewPanel = document.getElementById('xmlView');
        const xmlOutputContainer = xmlViewPanel.querySelector('.xml-output');
        const copyXmlButton = document.getElementById('copyXmlButton');
        const codingButtonsContainer = document.getElementById('coding-buttons-container');

        // Navigation Elements
        const navTracker = document.getElementById('navTracker');
        const navConfig = document.getElementById('navConfig');
        const navLog = document.getElementById('navLog');
        const navStats = document.getElementById('navStats');
        const navSavedGames = document.getElementById('navSavedGames');

        // View Elements
        const trackerView = document.getElementById('tracker-view');
        const configView = document.getElementById('config-view');
        const logView = document.getElementById('log-view');
        const statsView = document.getElementById('stats-view');
        const savedGamesView = document.getElementById('saved-games-view');

        const configJsonInput = document.getElementById('configJsonInput');
        const saveConfigButton = document.getElementById('saveConfigButton');
        const loadDefaultConfigButton = document.getElementById('loadDefaultConfigButton');
        const configMessage = document.getElementById('configMessage');
        const videoDropZone = document.getElementById('video-drop-zone');
        const videoFileInput = document.getElementById('videoFile');
        const videoFileName = document.getElementById('videoFileName');
        const videoPlayer = document.getElementById('videoPlayer');

        class Router {
            constructor(views) {
                this.views = views;
            }

            showView(viewToShow) {
                // Hide all views and reset navigation button styles
                Object.values(this.views).forEach(({ view, button }) => {
                    view.classList.add('hidden');
                    button.classList.remove('text-white', 'hover:text-white');
                    button.classList.add('text-gray-400', 'hover:text-white');
                });
                const selectedView = this.views[viewToShow];
                if (!selectedView) {
                    console.error(`Invalid view: ${viewToShow}`);
                    return;
                }

                // Show the selected view and highlight its button
                selectedView.view.classList.remove('hidden');
                selectedView.button.classList.add('text-white', 'hover:text-white');
                selectedView.button.classList.remove('text-gray-400', 'hover:text-white');

                // Additional logic for specific views
                if (viewToShow === 'config') {
                    const currentConfig = loadConfig(LOCAL_STORAGE_KEY_CONFIG, DEFAULT_CONFIG);
                    configJsonInput.value = JSON.stringify(currentConfig, null, 2);
                } else if (viewToShow === 'log') {
                    eventLog.render(currentGameState.loggedEvents);
                } else if (viewToShow === 'statistics') {
                    renderStatistics('statsContainer', currentGameState);
                } else if (viewToShow === 'saved-games') {
                    renderSavedGamesList();
                }
            }
        }

        class EventLog {
            constructor(listContainer, xmlContainer) {
                this.listContainer = listContainer;
                this.xmlContainer = xmlContainer;
            }

            render(events) {

                const logIsEmpty = events.length === 0;
                copyXmlButton.disabled = logIsEmpty;

                if (logIsEmpty) {
                    this.listContainer.innerHTML = '<p class="text-gray-500 text-center">No events recorded yet.</p>';
                    this.xmlContainer.innerHTML = '<p class="text-gray-500 text-center">No events recorded yet.</p>';
                    return;
                }

                this.listContainer.innerHTML = events.map(event => {
                    const eventTime = new Date(event.timeMs).toISOString().substr(11, 8);
                    return `
                        <div class="event-log-item">
                            <span>${event.event}</span>
                            <span>${eventTime}</span>
                        </div>
                    `;
                }).join('');

                let styledXmlString = '';
                events.forEach((logEntry, index) => {
                    const eventTimeSeconds = Math.floor(logEntry.timeMs / 1000);
                    const startSeconds = Math.max(0, eventTimeSeconds - 5);
                    const endSeconds = eventTimeSeconds + 5;
                    const eventCode = escapeXml(logEntry.event);
                    styledXmlString += `<span class="xml-tag">&lt;instance&gt;</span><span class="xml-tag">&lt;ID&gt;</span><span class="xml-text">${index + 1}</span><span class="xml-tag">&lt;/ID&gt;</span><span class="xml-tag">&lt;start&gt;</span><span class="xml-text">${startSeconds}</span><span class="xml-tag">&lt;/start&gt;</span><span class="xml-tag">&lt;end&gt;</span><span class="xml-text">${endSeconds}</span><span class="xml-tag">&lt;/end&gt;</span><span class="xml-tag">&lt;code&gt;</span><span class="xml-text">${eventCode}</span><span class="xml-tag">&lt;/code&gt;</span><span class="xml-tag">&lt;/instance&gt;</span>\n`;
                });
                this.xmlContainer.innerHTML = styledXmlString;
            }
        }



        // --- State Management
        const currentGameState = {
            loggedEvents: [],
            isRunning: false,
            elapsedTime: 0,
            startTime: 0,
            timerInterval: null,
            hasCurrentGame: false,
            isActive: false,
            setGameState({ loggedEvents = [], elapsedTime = 0, hasCurrentGame = false, isActive = false }) {
                this.loggedEvents = loggedEvents;
                this.elapsedTime = elapsedTime;
                this.hasCurrentGame = hasCurrentGame;
                this.isActive = isActive;
                eventLog.render(loggedEvents);
            },
        };

        // New Game Button, Pause/Resume Button, Complete Game Button
        createButton({
            id: 'newGameButton',
            text: 'Start Game',
            className: 'event-button btn-green px-6 py-3 text-lg',
            onClick: () => {
                let game = {
                    loggedEvents: [],
                    elapsedTime: 0,
                    hasCurrentGame: true,
                    isActive: true,
                };
                initializeNewGame(game);
            }
        });

        createButton({
            id: 'pauseResumeButton',
            text: 'Pause',
            className: 'event-button btn-yellow px-6 py-3 text-lg hidden',
            onClick: () => {
                if (currentGameState.isRunning) {
                    pauseTimer();
                } else {
                    startTimer();
                }
            }
        });

        createButton({
            id: 'completeGameButton',
            text: 'Complete',
            className: 'event-button btn-blue px-6 py-3 text-lg hidden',
            onClick: async () => {
                const userConfirmed = confirm('Are you sure you want to complete the game? This will reset all progress.');
                if (userConfirmed) {

                    await saveGameToLocalStorage({
                        events: currentGameState.loggedEvents,
                        elapsedTime: currentGameState.elapsedTime,
                        timestamp: new Date().toISOString()
                    }, LOCAL_STORAGE_KEY_GAMES);

                    resetTimerAndLog();
                    updateNavbarVisibility(currentGameState);
                }
            }
        });

        // --- Functions
        function initializeNewGame(game) {

            currentGameState.setGameState(game);
            timerDisplay.textContent = '00:00';

            newGameButton.style.display = 'inline-block';
            pauseResumeButton.style.display = 'none';
            completeGameButton.style.display = 'none';

            if (game.isActive === true) {
                startTimer();

                newGameButton.style.display = 'none';
                pauseResumeButton.style.display = 'inline-block';
                completeGameButton.style.display = 'inline-block';
            }

            updateNavbarVisibility(currentGameState);
        }

        function updateTimer() {
            const currentTime = Date.now();
            const currentElapsedTime = currentGameState.isRunning ? currentGameState.elapsedTime + (currentTime - currentGameState.startTime) : currentGameState.elapsedTime;
            timerDisplay.textContent = formatTime(currentElapsedTime);
        }

        function startTimer() {
            if (currentGameState.isRunning) return;

            currentGameState.startTime = Date.now();
            currentGameState.timerInterval = setInterval(updateTimer, 100);
            currentGameState.isRunning = true;

            pauseResumeButton.textContent = 'Pause';
            pauseResumeButton.classList.remove('btn-green');
            pauseResumeButton.classList.add('btn-yellow');
            pauseResumeButton.style.color = '#000000';

            enableEventButtons(true);
        }

        function pauseTimer() {
            if (!currentGameState.isRunning) return;

            clearInterval(currentGameState.timerInterval);

            const currentTime = Date.now();
            currentGameState.elapsedTime += (currentTime - currentGameState.startTime);
            currentGameState.isRunning = false;

            pauseResumeButton.textContent = 'Resume';
            pauseResumeButton.classList.remove('btn-yellow');
            pauseResumeButton.classList.add('btn-green');
            pauseResumeButton.style.color = '#ffffff';

            enableEventButtons(false);
        }

        function resetTimerAndLog() {
            pauseTimer();
            currentGameState.setGameState({
                loggedEvents: [],
                elapsedTime: 0,
                hasCurrentGame: false,
            });

            timerDisplay.textContent = '00:00';
            newGameButton.style.display = 'inline-block';
            pauseResumeButton.style.display = 'none';
            completeGameButton.style.display = 'none';

            eventLog.render(currentGameState.loggedEvents);
            enableEventButtons(false);
            updateNavbarVisibility(currentGameState);
        }

        function enableEventButtons(enable) {
            const logIsEmpty = currentGameState.loggedEvents.length === 0;
            let eventButtons = document.querySelectorAll('.event-button[data-event]');

            eventButtons.forEach(button => {
                button.disabled = !enable;
            });
            copyXmlButton.disabled = logIsEmpty;
        }

        function handleEventButtonClick(e) {
            if (!currentGameState.isActive) {
                console.warn("Timer not started. Event not logged.");
                timerDisplay.classList.add('animate-pulse');
                setTimeout(() => timerDisplay.classList.remove('animate-pulse'), 1000);
                return;
            }
            const eventName = e.target.dataset.event;
            const currentElapsedTimeMs = currentGameState.isRunning ? currentGameState.elapsedTime + (Date.now() - currentGameState.startTime) : currentGameState.elapsedTime;
            currentGameState.loggedEvents.push({ event: eventName, timeMs: currentElapsedTimeMs });
            eventLog.render(currentGameState.loggedEvents);
        }

        function switchTab(tabToShow) {
            const isListView = tabToShow === 'listView';
            tabButtonList.classList.toggle('tab-button-active', isListView);
            tabButtonXml.classList.toggle('tab-button-active', !isListView);
            tabButtonList.classList.toggle('tab-button', !isListView);
            tabButtonXml.classList.toggle('tab-button', isListView);
            listViewPanel.classList.toggle('hidden', !isListView);
            xmlViewPanel.classList.toggle('hidden', isListView);
        }

        function renderEventButtons(currentGame, config, targetContainer) {

            targetContainer.innerHTML = '';

            const renderGroup = (group) => {
                if (!group || !Array.isArray(group.buttons)) {
                    console.warn("Skipping invalid group in config:", group);
                    return; // Skip invalid groups
                }
                const groupContainer = document.createElement('div');
                groupContainer.className = 'group-container';

                const gridColsClass = group.gridCols || 'grid-cols-4'; // Default if not specified
                const buttonGridHTML = `
                    <div class="button-grid ${gridColsClass}">
                        ${group.buttons.map(buttonConfig => {
                    if (!buttonConfig || !buttonConfig.event || !buttonConfig.text || !buttonConfig.color) {
                        console.warn("Skipping invalid button config:", buttonConfig);
                        return '';
                    }
                    return `
                                        <button class="event-button ${buttonConfig.color}" style="padding: 0.5rem 1rem;" data-event="${buttonConfig.event}">
                                            ${buttonConfig.text}
                                        </button>
                                    `;
                }).join('')}
                    </div>
                `;

                groupContainer.innerHTML = buttonGridHTML;
                targetContainer.appendChild(groupContainer);
            };

            if (config.rowDefs && Array.isArray(config.rowDefs)) {
                config.rowDefs.forEach(renderGroup);
            }

            let eventButtons = document.querySelectorAll('.event-button[data-event]');
            eventButtons.forEach(button => {
                button.removeEventListener('click', handleEventButtonClick);
                button.addEventListener('click', handleEventButtonClick);
            });

            addVisualFeedbackToButtons(eventButtons);
            enableEventButtons(currentGame.isActive);
        }

        function renderStatistics(statsContainerId, currentGame) {
            const statsContainer = document.getElementById(statsContainerId);
            statsContainer.innerHTML = '';

            let gameStatistics = computeGameStatistics(currentGame);

            if (Object.keys(gameStatistics).length === 0) {
                statsContainer.innerHTML = '<p class="text-gray-500 text-center">No statistics available.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full bg-white border border-gray-200';

            const thead = document.createElement('thead');
            thead.innerHTML = `
        <tr>
            <th class="px-4 py-2 border-b">Event</th>
            <th class="px-4 py-2 border-b">Count</th>
        </tr>
    `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            Object.entries(gameStatistics).forEach(([event, count]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td class="px-4 py-2 border-b">${event}</td>
            <td class="px-4 py-2 border-b">${count}</td>
        `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            statsContainer.appendChild(table);
        }

        function renderSavedGamesList() {
            const savedGamesList = document.getElementById('savedGamesList');
            savedGamesList.innerHTML = '';

            try {
                const savedGames = loadSavedGames(LOCAL_STORAGE_KEY_GAMES);
                if (savedGames.length > 0) {
                    savedGames.forEach((game, index) => {
                        const gameCard = createGameCard({
                            game,
                            index,
                            onLoad: () => {
                                if (currentGameState.isRunning) {
                                    if (confirm('A game is currently in progress. Do you want to stop it and load the saved game?')) {
                                        pauseTimer();
                                    } else {
                                        return;
                                    }
                                }

                                initializeNewGame({
                                    loggedEvents: [...game.events],
                                    elapsedTime: 0,
                                    hasCurrentGame: true,
                                    isActive: false,
                                });

                                console.log(`Game ${index + 1} loaded successfully.`);
                                renderStatistics('statsContainer', currentGameState);
                                router.showView('statistics');
                            },
                            onDelete: () => {
                                if (confirm('Are you sure you want to delete this saved game?')) {
                                    deleteSavedGame(index, LOCAL_STORAGE_KEY_GAMES);
                                    renderSavedGamesList();
                                }
                            }
                        });

                        savedGamesList.appendChild(gameCard);
                    });
                } else {
                    savedGamesList.innerHTML = '<p class="text-gray-500 text-center">No saved games available.</p>';
                }
            } catch (error) {
                console.error('Error loading games from localStorage:', error);
                savedGamesList.innerHTML = '<p class="text-red-500 text-center">Failed to load saved games.</p>';
            }
        }



        const router = new Router({
            tracker: { view: trackerView, button: navTracker },
            config: { view: configView, button: navConfig },
            log: { view: logView, button: navLog },
            statistics: { view: statsView, button: navStats },
            'saved-games': { view: savedGamesView, button: navSavedGames },
        });

        const eventLog = new EventLog(listViewPanel, xmlOutputContainer, copyXmlButton);

        function initApp() {

            // Attach listeners
            tabButtonList.addEventListener('click', () => switchTab('listView'));
            tabButtonXml.addEventListener('click', () => switchTab('xmlView'));
            copyXmlButton.addEventListener('click', () => {
                const xmlContent = xmlOutputContainer.textContent;
                copyXmlToClipboard(xmlContent);
            });

            navTracker.addEventListener('click', () => router.showView('tracker'));
            navStats.addEventListener('click', () => router.showView('statistics'));
            navConfig.addEventListener('click', () => router.showView('config'));
            navLog.addEventListener('click', () => router.showView('log'));
            navSavedGames.addEventListener('click', () => {
                renderSavedGamesList();
                router.showView('saved-games');
            });

            saveConfigButton.addEventListener('click', () => {
                try {
                    const jsonString = configJsonInput.value;
                    const parsedConfig = JSON.parse(jsonString);
                    if (parsedConfig && Array.isArray(parsedConfig.rowDefs)) {
                        if (saveConfig(parsedConfig, LOCAL_STORAGE_KEY_CONFIG)) {
                            showMessage(configMessage, "Configuration saved successfully!", false);
                            renderEventButtons(currentGameState, parsedConfig, codingButtonsContainer);
                        } else {
                            showMessage(configMessage, "Failed to save configuration.", true);
                        }
                    } else {
                        console.error(configMessage, "Invalid configuration structure. Loading default configuration.");
                        configJsonInput.value = JSON.stringify(DEFAULT_CONFIG, null, 2);
                        showMessage(configMessage, "Default configuration loaded into editor. Click 'Save Configuration' to apply.", false);
                    }
                } catch (error) {
                    console.error("Invalid JSON:", error);
                    showMessage(configMessage, `Error parsing JSON: ${error.message}`, true);
                }
            });
            loadDefaultConfigButton.addEventListener('click', () => { configJsonInput.value = JSON.stringify(DEFAULT_CONFIG, null, 2); showMessage(configMessage, "Default configuration loaded into editor. Click 'Save Configuration' to apply.", false); });

            const currentConfig = loadConfig(LOCAL_STORAGE_KEY_CONFIG, DEFAULT_CONFIG);

            // Initial UI state
            eventLog.render(currentGameState.loggedEvents);
            renderEventButtons(currentGameState, currentConfig, codingButtonsContainer);
            enableEventButtons(false);
            switchTab('listView');
            router.showView('tracker');
            updateNavbarVisibility(currentGameState);
        }

        initApp();


    </script>

</body>

</html>